<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nablachat</title>
    <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚’è¿½åŠ  -->
    <link rel="icon" href="favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, deleteDoc, writeBatch,
            onSnapshot, updateDoc, serverTimestamp, query, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variable Setup
        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, deleteDoc, writeBatch,
            onSnapshot, updateDoc, serverTimestamp, query, runTransaction
        };
    </script>

    <style>
        /* Base Styles */
        :root {
            --bg-primary: #f3f4f6;
            --text-primary: #1f2937;
            --card-bg: #ffffff;
            --accent: #3b82f6;
            --msg-num-bg: #dbeafe;
            --msg-num-text: #1e40af;
        }

        body.dark-mode {
            --bg-primary: #111827;
            --text-primary: #f3f4f6;
            --card-bg: #1f2937;
            --accent: #60a5fa;
            --msg-num-bg: #1e3a8a;
            --msg-num-text: #93c5fd;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .card {
            background-color: var(--card-bg);
            transition: background-color 0.3s;
        }

        /* CRITICAL FIX: Ensure hidden elements are actually hidden */
        .hidden {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* Modal Overlay specific style */
        .modal-overlay {
            display: none; /* Default hidden */
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100; /* High z-index */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        /* When active, override display none */
        .modal-overlay.active {
            display: flex !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        /* Message Formatting */
        .msg-content a { color: var(--accent); text-decoration: underline; }
        .msg-anchor { color: var(--accent); cursor: pointer; font-weight: bold; background: rgba(59, 130, 246, 0.1); padding: 0 4px; border-radius: 4px; }
        .msg-bold { font-weight: bold; }
        .msg-italic { font-style: italic; }
        .msg-underline { text-decoration: underline; }
        
        /* NEW STYLES: Spoiler & Code */
        .spoiler {
            background-color: #1f2937;
            color: #1f2937; /* Hide text initially */
            padding: 0 4px;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s, background-color 0.2s;
        }
        .spoiler.revealed {
            color: #f3f4f6; /* Show text (light) */
        }
        body:not(.dark-mode) .spoiler.revealed {
            color: #ffffff;
        }
        
        .inline-code {
            background-color: #e5e7eb;
            color: #be185d;
            font-family: monospace;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #d1d5db;
        }
        body.dark-mode .inline-code {
            background-color: #374151;
            color: #f472b6;
            border-color: #4b5563;
        }

        /* Message Number Badge */
        .msg-number {
            background-color: var(--msg-num-bg);
            color: var(--msg-num-text);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.75rem;
            display: inline-block;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        body.dark-mode ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Loader */
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tooltip / Popover for colors */
        .color-palette {
            display: flex;
            gap: 6px;
            padding: 8px;
            background: var(--card-bg);
            border: 1px solid #ccc;
            border-radius: 8px;
            position: absolute;
            bottom: 100%;
            left: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
            margin-bottom: 10px;
            flex-wrap: wrap;
            width: 140px;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.1s;
            padding: 0;
            appearance: none;
        }
        .color-swatch:hover {
            transform: scale(1.2);
            border-color: rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* Mikan Effect */
        .mikan {
            position: fixed;
            top: -50px;
            font-size: 2rem;
            z-index: 9999;
            pointer-events: none;
        }
        
        /* Action Button Hover */
        .btn-action:hover {
            transform: scale(1.15);
        }
        
        /* Pinned Style */
        .pinned-thread {
            border-left: 4px solid var(--accent) !important;
            background-color: rgba(59, 130, 246, 0.03);
        }
        
        /* Admin View Z-Index Fix */
        #view-admin {
            z-index: 60; 
        }

        /* Native Color Picker Styled */
        .native-color-picker-wrapper {
            position: relative;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid #ccc;
            cursor: pointer;
            background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
            transition: transform 0.1s;
        }
        .native-color-picker-wrapper:hover {
            transform: scale(1.1);
        }
        .native-color-picker-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150%;
            height: 150%;
            padding: 0;
            margin: 0;
            border: none;
            cursor: pointer;
            opacity: 0;
        }
    </style>
</head>
<body class="text-base h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="card shadow-md z-10 p-4 flex justify-between items-center h-16 shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="app.router.navigate('')">
            <!-- Logo: Reset to nablog2.png -->
            <img src="./nablog2.png" 
                 alt="Nablachat Logo" 
                 class="h-10 object-contain hover:opacity-80 transition"
                 onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='flex';">
            
            <div id="fallback-logo" style="display:none;" class="flex items-center gap-2">
                <i class="fa-solid fa-shapes text-2xl text-blue-500"></i>
                <h1 class="text-xl font-bold tracking-wider">Nablachat</h1>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="app.ui.toggleSettings()" class="hover:text-blue-500 transition"><i class="fa-solid fa-gear text-lg"></i></button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-container" class="flex-1 relative overflow-hidden">
        
        <!-- VIEW: Home / Thread List -->
        <div id="view-home" class="view absolute inset-0 flex flex-col p-4 md:p-8 overflow-y-auto hidden">
            <div class="max-w-4xl mx-auto w-full">
                <!-- Search & Header -->
                <div class="mb-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
                        <button onclick="app.ui.showCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition transform hover:scale-105">
                            <i class="fa-solid fa-plus mr-2"></i>ä½œæˆ
                        </button>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="thread-search" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æ¤œç´¢... (IDæ¤œç´¢ã‚‚å¯)" oninput="app.logic.filterThreads()" 
                               class="w-full card border border-gray-300 dark:border-gray-600 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:border-blue-500 transition shadow-sm">
                    </div>
                    
                    <!-- Search Result Count -->
                    <div id="search-result-count" class="text-sm text-gray-500 text-right h-5 opacity-0 transition-opacity">
                        æ¤œç´¢çµæœ: <span id="count-number" class="font-bold">0</span> ä»¶
                    </div>

                    <!-- Tab Switcher -->
                    <div class="flex gap-2 border-b border-gray-300 dark:border-gray-700">
                        <button onclick="app.logic.switchTab('saved')" id="tab-saved" class="px-4 py-2 border-b-2 border-blue-500 font-bold text-blue-500 transition">
                            <i class="fa-solid fa-star mr-1"></i>ä¿å­˜ã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰
                        </button>
                        <button onclick="app.logic.switchTab('all')" id="tab-all" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition">
                            <i class="fa-solid fa-globe mr-1"></i>ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰
                        </button>
                    </div>
                </div>

                <div id="thread-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">
                    <!-- Threads will be injected here -->
                    <div class="loader mx-auto col-span-full mt-10"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: Chat Room -->
        <div id="view-chat" class="view absolute inset-0 flex flex-col hidden">
            <!-- Chat Header -->
            <div class="bg-opacity-90 card border-b border-gray-200 dark:border-gray-700 p-3 flex justify-between items-center shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-2">
                    <button onclick="app.router.navigate('')" class="mr-2 text-gray-500 hover:text-blue-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            <h2 id="room-title" class="font-bold text-lg leading-tight truncate">èª­ã¿è¾¼ã¿ä¸­...</h2>
                            <span id="room-badge" class="hidden text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-bold">å…¬å¼</span>
                            <span id="room-private-badge" class="hidden text-xs bg-gray-600 text-white px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-lock mr-1"></i>Private</span>
                            <!-- BGM Status Indicator -->
                            <span id="room-bgm-status" class="hidden text-xs bg-pink-500 text-white px-2 py-0.5 rounded-full font-bold animate-pulse cursor-pointer" onclick="app.logic.toggleBGM()"><i class="fa-solid fa-music mr-1"></i>BGM ON</span>
                        </div>
                        <span id="room-id-display" class="text-xs text-gray-400 font-mono">ID: ...</span>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-50 dark:bg-gray-900">
                <!-- Messages injected here -->
            </div>

            <!-- Input Area -->
            <div class="card p-3 border-t border-gray-200 dark:border-gray-700 shrink-0 shadow-lg z-20">
                <form id="message-form" class="max-w-4xl mx-auto flex flex-col gap-2">
                    <!-- Toolbar -->
                    <div class="flex items-center gap-1 overflow-x-auto pb-1 relative" id="toolbar">
                        <button type="button" onclick="app.ui.insertTag('**', '**')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="å¤ªå­—">
                            <i class="fa-solid fa-bold"></i>
                        </button>
                        <button type="button" onclick="app.ui.insertTag('*', '*')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="æ–œä½“">
                            <i class="fa-solid fa-italic"></i>
                        </button>
                        <button type="button" onclick="app.ui.insertTag('__', '__')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="ä¸‹ç·š">
                            <i class="fa-solid fa-underline"></i>
                        </button>
                        
                        <!-- Simplified Color Selection -->
                        <div class="flex gap-1 items-center mx-1">
                            <button type="button" onclick="app.ui.insertColor('#ef4444')" class="w-5 h-5 rounded-full bg-red-500 hover:scale-110 transition shadow-sm border border-gray-300" title="èµ¤"></button>
                            <button type="button" onclick="app.ui.insertColor('#3b82f6')" class="w-5 h-5 rounded-full bg-blue-500 hover:scale-110 transition shadow-sm border border-gray-300" title="é’"></button>
                            <button type="button" onclick="app.ui.insertColor('#22c55e')" class="w-5 h-5 rounded-full bg-green-500 hover:scale-110 transition shadow-sm border border-gray-300" title="ç·‘"></button>
                            <div class="native-color-picker-wrapper" title="è‡ªç”±ãªè‰²ã‚’é¸æŠ">
                                <input type="color" class="native-color-picker-input" onchange="app.ui.insertColor(this.value); this.value='#000000';">
                            </div>
                        </div>

                        <button type="button" onclick="app.ui.insertTag('>>', '')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="ã‚¢ãƒ³ã‚«ãƒ¼">
                            <i class="fa-solid fa-reply"></i>
                        </button>
                        
                        <button type="button" onclick="app.ui.insertTag('||', '||')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="ã‚¹ãƒã‚¤ãƒ©ãƒ¼">
                            <i class="fa-solid fa-eye-slash"></i>
                        </button>
                        <button type="button" onclick="app.ui.insertTag('`', '`')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="ã‚³ãƒ¼ãƒ‰">
                            <i class="fa-solid fa-code"></i>
                        </button>
                         <button type="button" onclick="app.ui.insertTag('\\[', ']')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="è£…é£¾ç„¡åŠ¹åŒ–">
                            <i class="fa-solid fa-ban"></i>
                        </button>

                        <div class="border-l border-gray-300 dark:border-gray-600 h-6 mx-1"></div>
                        
                        <input type="text" id="input-name" placeholder="åå‰ (ä»»æ„)" class="bg-transparent border-none text-sm focus:outline-none w-24 text-gray-600 dark:text-gray-300">
                    </div>

                    <div class="flex gap-2 items-end">
                        <textarea id="input-content" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." class="card border border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 w-full focus:outline-none focus:border-blue-500 resize-none transition-all focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900" style="min-height: 48px; max-height: 120px;"></textarea>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition transform active:scale-95 shrink-0">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- VIEW: Admin Panel -->
        <div id="view-admin" class="view absolute inset-0 flex flex-col hidden bg-gray-100 dark:bg-gray-900">
            <div class="bg-red-600 text-white p-4 shadow-md flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved text-xl"></i>
                    <h1 class="font-bold text-lg">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.logic.logoutAdmin()" class="bg-red-800 text-white px-3 py-1 rounded text-sm font-bold hover:bg-red-900 border border-red-700">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                    <button onclick="app.router.navigate('')" class="bg-white text-red-600 px-3 py-1 rounded text-sm font-bold hover:bg-gray-100">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i> é€šå ±ä¸€è¦§
                    <button onclick="app.logic.refreshAdmin()" class="text-sm font-normal bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded ml-2 text-gray-600 dark:text-gray-300 hover:bg-gray-300"><i class="fa-solid fa-sync"></i> æ›´æ–°</button>
                </h2>
                
                <div id="admin-report-list" class="space-y-4">
                    <div class="loader mx-auto mt-10"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals -->
    <!-- Create Thread Modal -->
    <div id="modal-create" class="modal-overlay">
        <div class="card p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300" id="modal-create-content">
            <h3 class="text-xl font-bold mb-4">æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="new-thread-title" class="w-full card border border-gray-300 dark:border-gray-600 rounded p-2 focus:outline-none focus:border-blue-500" placeholder="è©±é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«...">
                </div>
                
                <!-- NEW: Private Thread Option -->
                <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <label class="flex items-center space-x-2 cursor-pointer mb-2">
                        <input type="checkbox" id="new-thread-private" class="accent-blue-500 w-4 h-4" onchange="document.getElementById('new-thread-pass-container').classList.toggle('hidden')">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ã«ã™ã‚‹</span>
                    </label>
                    <p class="text-xs text-gray-500 dark:text-gray-400 ml-6 mb-2">ä¸€è¦§ã‚„æ¤œç´¢ã«è¡¨ç¤ºã•ã‚Œãšã€IDã‚’çŸ¥ã£ã¦ã„ã‚‹äººã ã‘ãŒå‚åŠ ã§ãã¾ã™ã€‚</p>
                    
                    <div id="new-thread-pass-container" class="hidden ml-6">
                        <label class="block text-xs font-medium mb-1">åˆè¨€è‘‰ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰<span class="text-gray-400 font-normal"> - 6æ¡ã®æ•°å­—</span></label>
                        <input type="number" id="new-thread-password" class="w-full card border border-gray-300 dark:border-gray-600 rounded p-2 text-sm focus:outline-none focus:border-blue-500" placeholder="6æ¡ã®æ•°å­— (ä»»æ„)">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1 text-red-500">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å…¬å¼/Testãƒ«ãƒ¼ãƒ ä½œæˆæ™‚ã®ã¿)</label>
                    <input type="password" id="new-thread-admin-pass" class="w-full card border border-gray-300 dark:border-gray-600 rounded p-2 focus:outline-none focus:border-red-500" placeholder="ç®¡ç†è€…ã®å ´åˆã®ã¿å…¥åŠ›">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.ui.closeModals()" class="px-4 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="app.logic.createThread()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">ä½œæˆ</button>
            </div>
        </div>
    </div>

    <!-- NEW: Room Password Modal -->
    <div id="modal-room-password" class="modal-overlay">
        <div class="card p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300" id="modal-room-password-content">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-lock text-gray-500"></i> åˆè¨€è‘‰ãŒå¿…è¦ã§ã™
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«å…¥å®¤ã™ã‚‹ã«ã¯åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="password" id="room-auth-input" class="w-full card border border-gray-300 dark:border-gray-600 rounded p-2 mb-4 focus:outline-none focus:border-blue-500" placeholder="6æ¡ã®æ•°å­—">
            <div class="flex justify-end gap-3">
                <button onclick="app.router.navigate('')" class="px-4 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition">æˆ»ã‚‹</button>
                <button onclick="app.logic.verifyRoomPassword()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">å…¥å®¤</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="modal-report" class="modal-overlay">
        <div class="card p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300" id="modal-report-content">
            <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i>é€šå ±</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€šå ±ã™ã‚‹ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            <form id="report-form" class="space-y-3">
                <input type="hidden" id="report-msg-id">
                <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
                    <input type="radio" name="report-reason" value="spam" class="accent-red-500" checked>
                    <span>ã‚¹ãƒ‘ãƒ  / å®£ä¼</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
                    <input type="radio" name="report-reason" value="harassment" class="accent-red-500">
                    <span>ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ / èª¹è¬—ä¸­å‚·</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
                    <input type="radio" name="report-reason" value="inappropriate" class="accent-red-500">
                    <span>ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
                    <input type="radio" name="report-reason" value="other" class="accent-red-500">
                    <span>ãã®ä»–</span>
                </label>
            </form>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.ui.closeModals()" class="px-4 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="app.logic.submitReport()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow transition">é€šå ±ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Help Manual Modal -->
    <div id="modal-help" class="modal-overlay">
        <!-- å¼·åˆ¶çš„ã«ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒé…è‰²ã‚’é©ç”¨ -->
        <div class="bg-gray-900 text-gray-100 p-6 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 flex flex-col max-h-[85vh] border border-gray-700" id="modal-help-content">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-book-open text-blue-400"></i>ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>
                <button onclick="app.ui.closeModals()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="overflow-y-auto pr-2 space-y-6 text-sm">
                <section>
                    <h4 class="font-bold text-lg mb-2 text-blue-400">æ–‡å­—ã®è£…é£¾</h4>
                    <ul class="list-disc pl-5 space-y-2 text-gray-300">
                        <li><b>å¤ªå­—</b>: <code>**æ–‡å­—**</code> â†’ <b>æ–‡å­—</b></li>
                        <li><i>æ–œä½“</i>: <code>*æ–‡å­—*</code> â†’ <i>æ–‡å­—</i></li>
                        <li><u>ä¸‹ç·š</u>: <code>__æ–‡å­—__</code> â†’ <u>æ–‡å­—</u></li>
                        <li>è‰²ä»˜ã: ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã€ã¾ãŸã¯ <code>#color:[#ff0000](æ–‡å­—)</code></li>
                        <li>ãƒã‚¿ãƒãƒ¬é˜²æ­¢: <code>||æ–‡å­—||</code> â†’ <span class="bg-gray-700 text-gray-700 px-1 rounded cursor-pointer select-none hover:text-white transition-colors">æ–‡å­—</span> (ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º)</li>
                        <li>ã‚³ãƒ¼ãƒ‰: <code>`æ–‡å­—`</code> â†’ <code class="bg-gray-800 px-1 rounded border border-gray-700 font-mono text-pink-400">æ–‡å­—</code> (ç­‰å¹…ãƒ•ã‚©ãƒ³ãƒˆãƒ»è£…é£¾ãªã—)</li>
                        <li>è£…é£¾ç„¡åŠ¹: <code>\[æ–‡å­—]</code> â†’ ãã®ã¾ã¾è¡¨ç¤º</li>
                        <li>ã‚¢ãƒ³ã‚«ãƒ¼: <code>>>1</code> â†’ æŒ‡å®šã—ãŸç•ªå·ã®æ›¸ãè¾¼ã¿ã¸ãƒªãƒ³ã‚¯</li>
                    </ul>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2 text-blue-400">ã‚¹ãƒ¬ãƒƒãƒ‰æ©Ÿèƒ½</h4>
                    <ul class="list-disc pl-5 space-y-2 text-gray-300">
                        <li><b>ä¿å­˜ï¼ˆãŠæ°—ã«å…¥ã‚Šï¼‰</b>: ä¸€åº¦å…¥å®¤ã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã€Œä¿å­˜ã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã€ã‚¿ãƒ–ã«è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™ã€‚ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³ã§è§£é™¤ã§ãã¾ã™ã€‚</li>
                        <li><b>ãƒ”ãƒ³ç•™ã‚</b>: <i class="fa-solid fa-thumbtack"></i> ãƒœã‚¿ãƒ³ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒªã‚¹ãƒˆã®ä¸€ç•ªä¸Šã«å›ºå®šã§ãã¾ã™ã€‚</li>
                        <li><b>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰</b>: ä½œæˆæ™‚ã«ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€æ¤œç´¢ã‚„ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚IDã‚’çŸ¥ã£ã¦ã„ã‚‹äººã ã‘ãŒå‚åŠ ã§ãã¾ã™ã€‚åˆè¨€è‘‰ï¼ˆ6æ¡æ•°å­—ï¼‰ã‚‚è¨­å®šå¯èƒ½ã§ã™ã€‚</li>
                    </ul>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2 text-blue-400">ãã®ä»–</h4>
                    <ul class="list-disc pl-5 space-y-2 text-gray-300">
                        <li><b>é€šå ±</b>: ä¸é©åˆ‡ãªæ›¸ãè¾¼ã¿ã¯ã€Œé€šå ±ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å ±å‘Šã—ã¦ãã ã•ã„ã€‚ç®¡ç†è€…ãŒç¢ºèªã—ã¾ã™ã€‚</li>
                        <li><b>ã‚¹ãƒ¬ãƒƒãƒ‰ã®å¯¿å‘½</b>: æœ€å¾Œã®æ›¸ãè¾¼ã¿ã‹ã‚‰2ãƒ¶æœˆçµŒéã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã¯è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚</li>
                    </ul>
                </section>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-700 text-right">
                <button onclick="app.ui.closeModals()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="modal-overlay">
        <div class="card p-6 rounded-t-xl md:rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300" id="modal-settings-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">è¨­å®š</h3>
                <button onclick="app.ui.closeModals()" class="text-gray-500"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
                    <button id="btn-theme-toggle" onclick="app.ui.toggleTheme()" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors duration-300">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                    </button>
                </div>
                <div>
                    <label class="block mb-2">æ–‡å­—ã‚µã‚¤ã‚º</label>
                    <input type="range" min="12" max="24" value="16" id="font-size-slider" class="w-full accent-blue-500" oninput="app.ui.changeFontSize(this.value)">
                </div>
                
                <div>
                    <button onclick="app.ui.showHelpModal()" class="w-full text-left py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-blue-500"></i>
                        <span>ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>
                    </button>
                </div>
                
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="app.logic.openAdminLoginModal()" class="w-full text-left text-gray-500 hover:text-red-500 text-sm transition">
                        <i class="fa-solid fa-shield-halved mr-2"></i>ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="modal-admin-login" class="modal-overlay">
        <div class="card p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300" id="modal-admin-login-content">
            <h3 class="text-xl font-bold mb-4">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="password" id="admin-password-input" class="w-full card border border-gray-300 dark:border-gray-600 rounded p-2 mb-4 focus:outline-none focus:border-blue-500" placeholder="Password">
            <div class="flex justify-end gap-3">
                <button onclick="app.ui.closeModals()" class="px-4 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="app.logic.submitAdminLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="card p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300" id="modal-confirm-content">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-circle-question text-blue-500"></i> ç¢ºèª
            </h3>
            <p id="confirm-message" class="text-gray-700 dark:text-gray-300 mb-6">ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end gap-3">
                <button onclick="app.ui.closeModals()" class="px-4 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- Logic & Config ---
        const app = {
            state: {
                user: null,
                currentRoomId: null,
                isDarkMode: false,
                unsubscribeRoom: null, // Listener cleanup
                threads: [], // Store fetched threads locally for search
                filterText: '',
                savedThreads: new Set(), // Set of saved (joined) thread IDs
                pinnedThreads: new Set(), // Set of pinned thread IDs
                currentTab: 'saved', // 'saved' (default) or 'all'
                unsubscribeThreadInfo: null, // Listener for thread meta info
                isAdmin: false, // Admin state
                secretRooms: ['test0123456789', 'mikan-room', 'funnycat'], // Define secret rooms
                tempRoomAuth: null, // Store room auth data temporarily
                bgmAudio: null // BGM Audio object
            },
            
            // Firebase References (Populated after module load)
            fb: {}, 
            
            async init() {
                // Wait for modules to import
                const modules = window.firebaseModules;
                if (!modules) return setTimeout(app.init, 100);

                // Initialize Firebase
                // ==========================================
                // â˜… ã“ã“ã«ã”è‡ªèº«ã®Firebaseè¨­å®šãŒå…¥ã‚Šã¾ã™ â˜…
                // ==========================================
                const firebaseConfig = {
                    apiKey: "AIzaSyCTu4Vpy2zq-UndQv32qOjbmgEp78TaBOs",
                    authDomain: "nbc2026-7eaab.firebaseapp.com",
                    projectId: "nbc2026-7eaab",
                    storageBucket: "nbc2026-7eaab.firebasestorage.app",
                    messagingSenderId: "545102518164",
                    appId: "1:545102518164:web:b2f3ce495fae9257ca2181",
                    measurementId: "G-JCZJ0WK2B2"
                };
                
                const fbApp = modules.initializeApp(firebaseConfig);
                app.fb.auth = modules.getAuth(fbApp);
                app.fb.db = modules.getFirestore(fbApp);
                
                // Firestoreãƒ«ãƒ¼ãƒ«ã¨ä¸€è‡´ã•ã›ã‚‹ID
                app.fb.appId = 'nablachat-app';
                console.log(`[Nablachat] App ID set to: ${app.fb.appId}. Checking permissions...`);
                
                // Map Firestore functions
                app.fb.collection = modules.collection;
                app.fb.doc = modules.doc;
                app.fb.addDoc = modules.addDoc;
                app.fb.setDoc = modules.setDoc;
                app.fb.deleteDoc = modules.deleteDoc;
                app.fb.writeBatch = modules.writeBatch;
                app.fb.getDoc = modules.getDoc;
                app.fb.getDocs = modules.getDocs;
                app.fb.onSnapshot = modules.onSnapshot;
                app.fb.updateDoc = modules.updateDoc;
                app.fb.serverTimestamp = modules.serverTimestamp;
                app.fb.query = modules.query;
                app.fb.runTransaction = modules.runTransaction;

                // Setup Auth
                try {
                    await modules.signInAnonymously(app.fb.auth);
                } catch (e) {
                    console.error("Auth Error", e);
                    alert("èªè¨¼ã‚¨ãƒ©ãƒ¼: " + e.message);
                }

                modules.onAuthStateChanged(app.fb.auth, (user) => {
                    if (user) {
                        app.state.user = user;
                        app.logic.loadSettings();
                        app.router.handleRoute(); // Initial Route
                    }
                });

                // Window Listeners
                window.addEventListener('hashchange', app.router.handleRoute);
                
                // Close color palette when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#toolbar')) {
                        // Just ensure UI focus is fine
                    }
                });
            },

            router: {
                navigate(path) {
                    window.location.hash = path;
                },
                handleRoute() {
                    const hash = window.location.hash.slice(1); // Remove #
                    
                    // Route change triggers modal close to prevent zombie modals
                    app.ui.closeModals();

                    if (hash === 'admin') {
                        app.state.currentRoomId = null;
                        app.logic.stopBGM(); // Stop BGM if leaving room
                        if (!app.state.isAdmin) {
                            app.logic.openAdminLoginModal();
                        } else {
                            app.ui.showView('view-admin');
                            app.logic.refreshAdmin();
                        }
                        return;
                    }
                    if (hash.startsWith('room/')) {
                        const roomId = hash.split('/')[1];
                        if (roomId) app.logic.enterRoom(roomId);
                    } else {
                        app.logic.showHome();
                    }
                }
            },

            ui: {
                showView(viewId) {
                    // Force hide all views properly
                    document.querySelectorAll('.view').forEach(el => {
                        el.classList.add('hidden');
                        el.style.display = 'none'; // Force style
                    });
                    const target = document.getElementById(viewId);
                    target.classList.remove('hidden');
                    target.style.display = 'flex'; // Force style
                },

                showCreateModal() {
                    app.ui.closeModals(); 
                    const modal = document.getElementById('modal-create');
                    modal.classList.add('active'); // Use new class-based toggle
                },

                showReportModal(msgId) {
                    app.ui.closeModals();
                    document.getElementById('report-msg-id').value = msgId;
                    document.getElementById('report-form').reset();
                    const modal = document.getElementById('modal-report');
                    modal.classList.add('active');
                },
                
                showRoomPasswordModal(roomId, correctPassword) {
                    app.ui.closeModals();
                    // Store target info for verification
                    app.state.tempRoomAuth = { roomId, correctPassword };
                    
                    document.getElementById('room-auth-input').value = "";
                    const modal = document.getElementById('modal-room-password');
                    modal.classList.add('active');
                },
                
                showHelpModal() {
                    app.ui.closeModals();
                    document.getElementById('modal-help').classList.add('active');
                },

                showConfirm(message, onConfirm) {
                    app.ui.closeModals();
                    const modal = document.getElementById('modal-confirm');
                    const msgEl = document.getElementById('confirm-message');
                    const okBtn = document.getElementById('confirm-ok-btn');
                    
                    msgEl.innerHTML = message;
                    
                    // Clone to remove old listeners
                    const newOkBtn = okBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    
                    newOkBtn.onclick = () => {
                        onConfirm();
                        app.ui.closeModals();
                    };
                    
                    modal.classList.add('active');
                },

                toggleSettings() {
                    const modal = document.getElementById('modal-settings');
                    if (modal.classList.contains('active')) {
                        app.ui.closeModals();
                    } else {
                        app.ui.closeModals();
                        modal.classList.add('active');
                    }
                },

                // FIXED: Robust modal closing targeting IDs
                closeModals() {
                    const modalIds = ['modal-create', 'modal-report', 'modal-settings', 'modal-admin-login', 'modal-confirm', 'modal-room-password', 'modal-help'];
                    modalIds.forEach(id => {
                        const m = document.getElementById(id);
                        if (m) m.classList.remove('active');
                    });
                },

                toggleTheme() {
                    app.state.isDarkMode = !app.state.isDarkMode;
                    document.body.classList.toggle('dark-mode', app.state.isDarkMode);
                    const toggle = document.querySelector('#btn-theme-toggle div');
                    const bg = document.querySelector('#btn-theme-toggle');
                    if (app.state.isDarkMode) {
                        toggle.style.transform = 'translateX(24px)';
                        bg.classList.remove('bg-gray-300');
                        bg.classList.add('bg-blue-600');
                    } else {
                        toggle.style.transform = 'translateX(0)';
                        bg.classList.add('bg-gray-300');
                        bg.classList.remove('bg-blue-600');
                    }
                    localStorage.setItem('nablachat_theme', app.state.isDarkMode ? 'dark' : 'light');
                },

                changeFontSize(size) {
                    document.body.style.fontSize = size + 'px';
                    localStorage.setItem('nablachat_fontsize', size);
                },

                scrollToBottom() {
                    const container = document.getElementById('chat-messages');
                    container.scrollTop = container.scrollHeight;
                },

                highlightMessage(num) {
                    const el = document.getElementById(`msg-${num}`);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Simple highlight without GSAP
                        el.style.backgroundColor = "rgba(59, 130, 246, 0.2)";
                        setTimeout(() => el.style.backgroundColor = "transparent", 2000);
                    }
                },

                // Toolbar Helpers
                insertTag(startTag, endTag) {
                    const textarea = document.getElementById('input-content');
                    textarea.focus(); 
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = textarea.value;
                    const before = text.substring(0, start);
                    const selection = text.substring(start, end);
                    const after = text.substring(end, text.length);

                    textarea.value = before + startTag + selection + endTag + after;
                    textarea.selectionStart = start + startTag.length;
                    textarea.selectionEnd = end + startTag.length;
                },

                insertColor(hex) {
                    app.ui.insertTag(`#color:[${hex}](`, ')');
                },
                
                triggerMikanEffect() {
                    const container = document.body;
                    for (let i = 0; i < 30; i++) {
                        const mikan = document.createElement('div');
                        mikan.className = 'mikan';
                        mikan.textContent = 'ğŸŠ';
                        mikan.style.left = Math.random() * 100 + 'vw';
                        // Use simple CSS animation
                        mikan.style.transition = `top ${2 + Math.random() * 3}s ease-in, transform 3s`;
                        mikan.style.top = '-50px';
                        container.appendChild(mikan);
                        
                        // Force reflow
                        void mikan.offsetWidth;
                        
                        mikan.style.top = (window.innerHeight + 100) + 'px';
                        mikan.style.transform = `rotate(${Math.random() * 360}deg)`;
                        
                        setTimeout(() => mikan.remove(), 5000);
                    }
                }
            },

            logic: {
                loadSettings() {
                    const savedTheme = localStorage.getItem('nablachat_theme');
                    if (savedTheme === 'dark') app.ui.toggleTheme();
                    
                    const savedSize = localStorage.getItem('nablachat_fontsize');
                    if (savedSize) {
                        document.getElementById('font-size-slider').value = savedSize;
                        app.ui.changeFontSize(savedSize);
                    }

                    const savedThreads = localStorage.getItem('nablachat_saved_threads');
                    if (savedThreads) {
                        try {
                            app.state.savedThreads = new Set(JSON.parse(savedThreads));
                        } catch (e) { console.error(e); }
                    }
                    
                    const savedPinned = localStorage.getItem('nablachat_pinned_threads');
                    if (savedPinned) {
                        try {
                            app.state.pinnedThreads = new Set(JSON.parse(savedPinned));
                        } catch (e) { console.error(e); }
                    }

                    // Check for admin persistence
                    const adminFlag = localStorage.getItem('nablachat_is_admin');
                    if (adminFlag === 'true') {
                        app.state.isAdmin = true;
                    }
                },

                switchTab(tab) {
                    app.state.currentTab = tab;
                    const savedTab = document.getElementById('tab-saved');
                    const allTab = document.getElementById('tab-all');
                    
                    if (tab === 'saved') {
                        savedTab.className = "px-4 py-2 border-b-2 border-blue-500 font-bold text-blue-500 transition";
                        allTab.className = "px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition";
                    } else {
                        savedTab.className = "px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition";
                        allTab.className = "px-4 py-2 border-b-2 border-blue-500 font-bold text-blue-500 transition";
                    }
                    app.logic.renderThreadList();
                },

                toggleLocalSave(threadId) {
                    const saved = app.state.savedThreads;
                    if (saved.has(threadId)) {
                        saved.delete(threadId);
                        if (app.state.pinnedThreads.has(threadId)) {
                            app.logic.togglePin(threadId);
                        }
                    } else {
                        saved.add(threadId);
                    }
                    localStorage.setItem('nablachat_saved_threads', JSON.stringify([...saved]));
                    app.logic.renderThreadList();
                },
                
                togglePin(threadId) {
                    const pinned = app.state.pinnedThreads;
                    if (pinned.has(threadId)) {
                        pinned.delete(threadId);
                    } else {
                        pinned.add(threadId);
                        if (!app.state.savedThreads.has(threadId)) {
                            app.state.savedThreads.add(threadId);
                            localStorage.setItem('nablachat_saved_threads', JSON.stringify([...app.state.savedThreads]));
                        }
                    }
                    localStorage.setItem('nablachat_pinned_threads', JSON.stringify([...pinned]));
                    app.logic.renderThreadList();
                },

                // BGM Functions
                playBGM(src) {
                    app.logic.stopBGM();
                    if (!src) return;
                    
                    const audio = new Audio(src);
                    audio.loop = true;
                    audio.volume = 0.3; 
                    
                    // Try auto-play
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            // Play started
                            app.state.bgmAudio = audio;
                            document.getElementById('room-bgm-status').classList.remove('hidden');
                        }).catch(error => {
                            // Auto-play blocked
                            console.log("Auto-play blocked:", error);
                            // Still set audio object but paused, show UI to play
                            app.state.bgmAudio = audio;
                            const statusEl = document.getElementById('room-bgm-status');
                            statusEl.classList.remove('hidden');
                            statusEl.classList.remove('bg-pink-500', 'animate-pulse');
                            statusEl.classList.add('bg-gray-500');
                            statusEl.innerHTML = '<i class="fa-solid fa-play mr-1"></i>BGM å†ç”Ÿ';
                        });
                    }
                },

                stopBGM() {
                    if (app.state.bgmAudio) {
                        app.state.bgmAudio.pause();
                        app.state.bgmAudio = null;
                        document.getElementById('room-bgm-status').classList.add('hidden');
                    }
                },
                
                toggleBGM() {
                    if (app.state.bgmAudio) {
                        if (app.state.bgmAudio.paused) {
                            app.state.bgmAudio.play();
                            const statusEl = document.getElementById('room-bgm-status');
                            statusEl.classList.remove('bg-gray-500');
                            statusEl.classList.add('bg-pink-500', 'animate-pulse');
                            statusEl.innerHTML = '<i class="fa-solid fa-music mr-1"></i>BGM ON';
                        } else {
                            app.state.bgmAudio.pause();
                            const statusEl = document.getElementById('room-bgm-status');
                            statusEl.classList.remove('bg-pink-500', 'animate-pulse');
                            statusEl.classList.add('bg-gray-500');
                            statusEl.innerHTML = '<i class="fa-solid fa-play mr-1"></i>BGM åœæ­¢ä¸­';
                        }
                    }
                },

                async showHome() {
                    if (app.state.unsubscribeRoom) app.state.unsubscribeRoom();
                    if (app.state.unsubscribeThreadInfo) app.state.unsubscribeThreadInfo(); // Clean up info listener
                    app.logic.stopBGM(); // Stop BGM when going home
                    app.state.currentRoomId = null;
                    app.ui.showView('view-home');
                    
                    const listEl = document.getElementById('thread-list');
                    
                    document.getElementById('thread-search').value = '';
                    app.state.filterText = '';
                    document.getElementById('search-result-count').classList.add('opacity-0');

                    try {
                        const threadsRef = app.fb.collection(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads');
                        const snapshot = await app.fb.getDocs(threadsRef);
                        
                        app.state.threads = []; 
                        const twoMonthsAgo = new Date();
                        twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);

                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const lastUpdated = data.lastUpdated?.toDate() || new Date();
                            if (lastUpdated > twoMonthsAgo && !data.archived) {
                                app.state.threads.push({ id: doc.id, ...data, lastUpdated });
                            }
                        });

                        app.logic.renderThreadList();

                    } catch (e) {
                        console.error("Error fetching threads", e);
                        let errorMsg = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                        let additionalInfo = '';
                        
                        if (e.code === 'permission-denied' || e.message.includes('permission')) {
                            errorMsg = 'ã€é‡è¦ï¼šã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼ã€‘<br>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒ«ãƒ¼ãƒ«è¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                            additionalInfo = `<div class="text-left bg-white p-2 rounded border mt-2 text-xs text-gray-700">
                                <strong>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« ï¼ Firestore ï¼ ãƒ«ãƒ¼ãƒ«</strong> ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š
                                <pre class="bg-gray-100 p-2 mt-1 select-all overflow-x-auto">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/nablachat-app/public/data/{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
                            </div>
                            <button onclick="app.router.handleRoute()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700">ãƒ«ãƒ¼ãƒ«ä¿®æ­£å¾Œã«å†èª­ã¿è¾¼ã¿</button>`;
                        }
                        
                        listEl.innerHTML = `<div class="col-span-full text-center text-red-500 py-10 card p-6 border-red-200 border bg-red-50">
                            <div class="font-bold text-lg mb-2">${errorMsg}</div>
                            ${additionalInfo}
                        </div>`;
                    }
                },

                filterThreads() {
                    const input = document.getElementById('thread-search');
                    app.state.filterText = input.value;
                    const lowerText = app.state.filterText.toLowerCase();

                    const secretHash = "ff4ace7ee32d4b2e7c5ceb325911d9e0ec8b241b8190002747b4932545c427625368906cc1208a68233387c093a7e2e1a26ba220ab259a7d16c7da297bdcfc30";
                    if (app.state.filterText === secretHash) {
                        input.value = "";
                        app.router.navigate('room/test0123456789'); 
                        return;
                    }
                    if (lowerText === "mikanchan") {
                        input.value = "";
                        app.ui.triggerMikanEffect();
                        setTimeout(() => app.router.navigate('room/mikan-room'), 1500); 
                        return;
                    }
                    if (lowerText === "funnycat") {
                        input.value = "";
                        app.router.navigate('room/funnycat'); 
                        return;
                    }

                    app.logic.renderThreadList();
                },

                renderThreadList() {
                    const listEl = document.getElementById('thread-list');
                    const countEl = document.getElementById('search-result-count');
                    const countNumEl = document.getElementById('count-number');
                    
                    listEl.innerHTML = '';
                    
                    const searchText = app.state.filterText.toLowerCase();
                    const isSavedTab = app.state.currentTab === 'saved';

                    let filtered = app.state.threads.filter(t => {
                        return (t.title || '').toLowerCase().includes(searchText) || t.id.toLowerCase().includes(searchText);
                    });

                    filtered = filtered.filter(t => {
                        // Secret rooms check
                        if (app.state.secretRooms.includes(t.id) && !app.state.isAdmin) return false;
                        
                        // Private threads check: Hide private threads from "All" tab
                        if (t.isPrivate && !isSavedTab && !app.state.isAdmin) { // FIX: Allow admins to see private threads
                            return false; 
                        }

                        const isSaved = app.state.savedThreads.has(t.id);
                        return isSavedTab ? isSaved : true;
                    });

                    filtered.sort((a, b) => {
                        const isPinnedA = app.state.pinnedThreads.has(a.id);
                        const isPinnedB = app.state.pinnedThreads.has(b.id);
                        if (isPinnedA && !isPinnedB) return -1;
                        if (!isPinnedA && isPinnedB) return 1;
                        return b.lastUpdated - a.lastUpdated;
                    });

                    if (searchText) {
                        countEl.classList.remove('opacity-0');
                        countNumEl.innerText = filtered.length;
                    } else {
                        countEl.classList.add('opacity-0');
                    }

                    if (filtered.length === 0) {
                        const msg = isSavedTab 
                            ? 'ä¿å­˜ã•ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã‚¿ãƒ–ã‹ã‚‰æ¢ã—ã¦å‚åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚' 
                            : 'ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                        listEl.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">${msg}</div>`;
                        return;
                    }

                    filtered.forEach(t => {
                        const dateStr = t.lastUpdated.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const isOfficial = t.isOfficial === true;
                        const isCreator = app.state.user && t.creator === app.state.user.uid;
                        const isAdmin = app.state.isAdmin;
                        
                        const isPinned = app.state.pinnedThreads.has(t.id);
                        const isSaved = app.state.savedThreads.has(t.id);
                        
                        // Check if secret room
                        const isSecret = app.state.secretRooms.includes(t.id);

                        const div = document.createElement('div');
                        let divClasses = `card p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer relative overflow-hidden group`;
                        if (isOfficial) divClasses += ' border-red-400 dark:border-red-500 border-2';
                        else divClasses += ' border-transparent hover:border-blue-300 border';
                        
                        if (isPinned) divClasses += ' pinned-thread';
                        
                        div.className = divClasses;
                        
                        div.onclick = (e) => {
                            if (!e.target.closest('.btn-action')) {
                                app.router.navigate(`room/${t.id}`);
                            }
                        };
                        
                        const badgeHtml = isOfficial 
                            ? `<span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold ml-2">å…¬å¼/Test</span>` 
                            : '';
                        
                        // Private icon
                        const privateHtml = t.isPrivate
                            ? `<i class="fa-solid fa-lock text-gray-400 text-xs ml-2" title="ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ"></i>`
                            : '';

                        let actionBtns = '';
                        
                        // Allow saving/pinning only if NOT secret OR user is Admin
                        if (!isSecret || isAdmin) {
                            if (isSaved) {
                                const pinIcon = isPinned ? 'fa-thumbtack text-blue-500' : 'fa-thumbtack text-gray-300';
                                actionBtns += `<button onclick="app.logic.togglePin('${t.id}')" class="btn-action absolute top-3 right-10 hover:text-blue-500 transition z-20 ${pinIcon}" title="ãƒ”ãƒ³ç•™ã‚/è§£é™¤">
                                    <i class="fa-solid fa-thumbtack"></i>
                                   </button>`;
                            }

                            if (isSaved) {
                                actionBtns += `<button onclick="app.logic.toggleLocalSave('${t.id}')" class="btn-action absolute top-3 right-3 text-gray-400 hover:text-red-500 transition z-20" title="ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆä¿å­˜è§£é™¤ï¼‰">
                                    <i class="fa-solid fa-trash"></i>
                                   </button>`;
                            } else {
                                actionBtns += `<button onclick="app.logic.toggleLocalSave('${t.id}')" class="btn-action absolute top-3 right-3 text-gray-300 hover:text-blue-500 transition z-20" title="ãƒªã‚¹ãƒˆã«ä¿å­˜">
                                    <i class="fa-solid fa-plus-circle"></i>
                                   </button>`;
                            }
                        }

                        // NEW: True Delete Button for Creator OR Admin
                        if ((isCreator || isAdmin) && !isSavedTab) {
                            actionBtns += `<button onclick="app.logic.deleteThread('${t.id}')" class="btn-action absolute top-3 right-16 text-gray-300 hover:text-red-500 transition z-20" title="ã€ä½œæˆè€…/ç®¡ç†è€…ã€‘ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤">
                                <i class="fa-solid fa-trash"></i>
                               </button>`;
                        }

                        div.innerHTML = `
                            ${actionBtns}
                            <div class="flex justify-between items-start mb-2 relative z-10 pr-24">
                                <h3 class="font-bold text-lg truncate pr-2 group-hover:text-blue-500 transition flex items-center">
                                    ${isPinned ? '<i class="fa-solid fa-thumbtack text-blue-500 mr-1 text-sm"></i>' : ''}
                                    ${app.logic.escapeHtml(t.title || 'ç„¡é¡Œã®ã‚¹ãƒ¬ãƒƒãƒ‰')}
                                    ${badgeHtml}
                                    ${privateHtml}
                                </h3>
                                <span class="text-xs font-mono px-2 py-1 rounded-md flex-shrink-0 bg-blue-50 text-blue-600 border border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600 shadow-sm font-bold" title="ãƒ¬ã‚¹æ•°">
                                    <i class="fa-regular fa-comment-dots mr-1"></i>${t.messageCount || 0}
                                </span>
                            </div>
                            <div class="flex justify-between items-end relative z-10">
                                <div class="text-xs text-gray-400 font-mono opacity-60 group-hover:opacity-100 transition">ID: ${t.id}</div>
                                <div class="text-xs text-gray-400">${dateStr}</div>
                            </div>
                        `;
                        listEl.appendChild(div);
                    });
                },

                async createThread() {
                    const titleInput = document.getElementById('new-thread-title');
                    const passInput = document.getElementById('new-thread-admin-pass');
                    
                    const isPrivateInput = document.getElementById('new-thread-private');
                    const roomPassInput = document.getElementById('new-thread-password');
                    
                    const title = titleInput.value.trim() || "åç„¡ã—ã®ã‚¹ãƒ¬ãƒƒãƒ‰";
                    const password = passInput.value.trim();
                    const isAdmin = (password === 'nabladmin');
                    
                    const isPrivate = isPrivateInput.checked;
                    const roomPassword = roomPassInput.value.trim();
                    
                    // FIX: Password validation
                    if (isPrivate && roomPassword && !/^\d{6}$/.test(roomPassword)) {
                        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                        return;
                    }

                    const threadsColl = app.fb.collection(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads');
                    const threadRef = app.fb.doc(threadsColl);
                    const roomId = threadRef.id;

                    try {
                        await app.fb.runTransaction(app.fb.db, async (transaction) => {
                             transaction.set(threadRef, {
                                title: title,
                                createdAt: app.fb.serverTimestamp(),
                                lastUpdated: app.fb.serverTimestamp(),
                                messageCount: 0,
                                isOfficial: isAdmin,
                                creator: app.state.user.uid,
                                archived: false,
                                isPrivate: isPrivate,
                                password: roomPassword // Can be empty string
                            });
                        });

                        app.state.savedThreads.add(roomId);
                        localStorage.setItem('nablachat_saved_threads', JSON.stringify([...app.state.savedThreads]));

                        app.ui.closeModals();
                        titleInput.value = "";
                        passInput.value = "";
                        isPrivateInput.checked = false;
                        roomPassInput.value = "";
                        document.getElementById('new-thread-pass-container').classList.add('hidden');
                        
                        app.router.navigate(`room/${roomId}`);

                    } catch (e) {
                        alert("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
                    }
                },
                
                // NEW: Complete Deletion Logic
                async deleteThread(roomId) {
                    app.ui.showConfirm("æœ¬å½“ã«ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã€å¾©å…ƒã§ãã¾ã›ã‚“ï¼‰", async () => {
                        try {
                            const threadRef = app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId);
                            const msgsColl = app.fb.collection(threadRef, 'messages');
                            
                            // 1. Delete all messages (Batch delete)
                            const snapshot = await app.fb.getDocs(msgsColl);
                            const batch = app.fb.writeBatch(app.fb.db);
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            // Also delete the thread doc
                            batch.delete(threadRef);
                            
                            await batch.commit();
                            
                            // Update local state
                            app.state.threads = app.state.threads.filter(t => t.id !== roomId);
                            app.logic.renderThreadList();
                            alert("ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                        } catch (e) {
                            console.error(e);
                            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
                        }
                    });
                },
                
                async deleteReportedThread(reportId, roomId) {
                    app.ui.showConfirm("å¯¾è±¡ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ¶ˆå»ã€é€šå ±ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆå»ï¼‰", async () => {
                        try {
                            const threadRef = app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId);
                            const msgsColl = app.fb.collection(threadRef, 'messages');
                            
                            // Batch delete messages
                            const snapshot = await app.fb.getDocs(msgsColl);
                            const batch = app.fb.writeBatch(app.fb.db);
                            snapshot.forEach(doc => batch.delete(doc.ref));
                            
                            // Delete thread doc and report doc
                            batch.delete(threadRef);
                            batch.delete(app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'reports', reportId));
                            
                            await batch.commit();
                            alert("ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                            app.logic.refreshAdmin();
                        } catch (e) {
                            console.error(e);
                            alert("å‰Šé™¤å¤±æ•—: " + e.message);
                        }
                    });
                },

                async reportMessage(msgId) {
                    app.ui.showReportModal(msgId);
                },

                async submitReport() {
                    const msgId = document.getElementById('report-msg-id').value;
                    const form = document.getElementById('report-form');
                    const reason = form.querySelector('input[name="report-reason"]:checked').value;
                    
                    const roomId = app.state.currentRoomId;
                    const reportsRef = app.fb.collection(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'reports');

                    try {
                        await app.fb.addDoc(reportsRef, {
                            roomId: roomId,
                            messageId: msgId,
                            reporter: app.state.user.uid,
                            timestamp: app.fb.serverTimestamp(),
                            reason: reason
                        });
                        app.ui.closeModals();
                        alert("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
                    } catch (e) {
                        console.error(e);
                        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                },

                // ADMIN FUNCTIONS
                openAdminLoginModal() {
                    app.ui.closeModals(); // Close settings modal
                    document.getElementById('modal-admin-login').classList.add('active');
                    document.getElementById('admin-password-input').value = ""; // clear
                },

                submitAdminLogin() {
                    const input = document.getElementById('admin-password-input');
                    const pass = input.value;
                    if (pass === "nabladmin") {
                        app.ui.closeModals();
                        app.state.isAdmin = true;
                        localStorage.setItem('nablachat_is_admin', 'true');
                        app.router.navigate('admin');
                    } else {
                        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                    }
                },
                
                logoutAdmin() {
                    app.state.isAdmin = false;
                    localStorage.removeItem('nablachat_is_admin');
                    app.router.navigate('');
                },

                async refreshAdmin() {
                    const listEl = document.getElementById('admin-report-list');
                    listEl.innerHTML = '<div class="loader mx-auto"></div>';
                    
                    try {
                        const reportsRef = app.fb.collection(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'reports');
                        const snap = await app.fb.getDocs(reportsRef);
                        
                        if (snap.empty) {
                            listEl.innerHTML = '<div class="text-center text-gray-500">é€šå ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                            return;
                        }

                        let html = '';
                        snap.forEach(doc => {
                            const data = doc.data();
                            const date = data.timestamp ? new Date(data.timestamp.toMillis()).toLocaleString() : 'ä¸æ˜';
                            const reasonMap = {
                                'spam': 'ã‚¹ãƒ‘ãƒ /å®£ä¼',
                                'harassment': 'èª¹è¬—ä¸­å‚·',
                                'inappropriate': 'ä¸é©åˆ‡',
                                'other': 'ãã®ä»–'
                            };
                            
                            html += `
                                <div class="card p-4 rounded shadow border border-gray-200 dark:border-gray-700">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-bold text-red-500">${reasonMap[data.reason] || data.reason}</span>
                                        <span class="text-xs text-gray-400">${date}</span>
                                    </div>
                                    <div class="text-sm mb-2">
                                        <div>RoomID: <span class="font-mono text-xs bg-gray-100 p-1">${data.roomId}</span></div>
                                        <div>MsgID: <span class="font-mono text-xs bg-gray-100 p-1">${data.messageId}</span></div>
                                        <div class="text-xs text-gray-400 mt-1">Reporter: ${data.reporter}</div>
                                    </div>
                                    <div class="flex gap-2 justify-end flex-wrap">
                                        <button onclick="app.logic.dismissReport('${doc.id}')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm transition">
                                            é€šå ±ã‚’å´ä¸‹
                                        </button>
                                        <button onclick="app.logic.deleteReportedMessage('${doc.id}', '${data.roomId}', '${data.messageId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition">
                                            æ›¸ãè¾¼ã¿å‰Šé™¤
                                        </button>
                                        <button onclick="app.logic.deleteReportedThread('${doc.id}', '${data.roomId}')" class="bg-red-800 hover:bg-red-900 text-white px-3 py-1 rounded text-sm transition border border-red-700">
                                            ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨å‰Šé™¤
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        listEl.innerHTML = html;

                    } catch (e) {
                        console.error(e);
                        listEl.innerHTML = `<div class="text-red-500">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
                    }
                },

                async dismissReport(reportId) {
                    app.ui.showConfirm("ã“ã®é€šå ±ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
                        try {
                            await app.fb.deleteDoc(app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'reports', reportId));
                            app.logic.refreshAdmin();
                        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
                    });
                },

                async deleteReportedMessage(reportId, roomId, messageId) {
                    app.ui.showConfirm("å¯¾è±¡ã®æ›¸ãè¾¼ã¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(å‰Šé™¤å¾Œã€é€šå ±ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆå»ã•ã‚Œã¾ã™)", async () => {
                        try {
                            const msgRef = app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId, 'messages', messageId);
                            await app.fb.deleteDoc(msgRef);
                            await app.fb.deleteDoc(app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'reports', reportId));
                            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                            app.logic.refreshAdmin();
                        } catch (e) {
                            console.error(e);
                            alert("å‰Šé™¤å¤±æ•—: " + e.message);
                        }
                    });
                },

                async enterRoom(roomId) {
                    if (app.state.unsubscribeThreadInfo) app.state.unsubscribeThreadInfo(); // Clear old listener
                    app.logic.stopBGM(); // Reset BGM state
                    app.state.currentRoomId = roomId;
                    
                    // Don't auto-save if it is a secret room unless admin
                    if (!app.state.secretRooms.includes(roomId) || app.state.isAdmin) {
                        if (!app.state.savedThreads.has(roomId)) {
                            app.state.savedThreads.add(roomId);
                            localStorage.setItem('nablachat_saved_threads', JSON.stringify([...app.state.savedThreads]));
                        }
                    }

                    app.ui.showView('view-chat');
                    
                    const titleEl = document.getElementById('room-title');
                    const badgeEl = document.getElementById('room-badge');
                    const privateBadgeEl = document.getElementById('room-private-badge');
                    const idEl = document.getElementById('room-id-display');
                    const bgmStatusEl = document.getElementById('room-bgm-status');
                    const msgContainer = document.getElementById('chat-messages');

                    titleEl.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
                    badgeEl.classList.add('hidden');
                    privateBadgeEl.classList.add('hidden');
                    bgmStatusEl.classList.add('hidden'); // Reset BGM indicator
                    idEl.innerText = `ID: ${roomId}`;
                    msgContainer.innerHTML = '<div class="loader mx-auto mt-10"></div>';
                    
                    // Special Room Logic (Auto create)
                    if (app.state.secretRooms.includes(roomId)) {
                        const threadRef = app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId);
                        const snap = await app.fb.getDoc(threadRef);
                        if (!snap.exists()) {
                            let roomTitle = 'ç§˜å¯†ã®éƒ¨å±‹';
                            if (roomId === 'mikan-room') roomTitle = 'ğŸŠ ã¿ã‹ã‚“ã®éš ã—éƒ¨å±‹ ğŸŠ';
                            if (roomId === 'test0123456789') roomTitle = 'é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨';
                            if (roomId === 'funnycat') roomTitle = 'ğŸ± Funny Cat Room ğŸ±';

                            await app.fb.setDoc(threadRef, {
                                title: roomTitle,
                                createdAt: app.fb.serverTimestamp(),
                                lastUpdated: app.fb.serverTimestamp(),
                                messageCount: 0,
                                isOfficial: true,
                                archived: false
                            });
                        }
                        
                        // BGM Logic for funnycat
                        if (roomId === 'funnycat') {
                             app.logic.playBGM('1161090_Funny-Cat.mp3');
                        }
                    }

                    const threadRef = app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId);
                    
                    // NEW: Realtime listener for thread existence/meta
                    app.state.unsubscribeThreadInfo = app.fb.onSnapshot(threadRef, (doc) => {
                        if (!doc.exists()) {
                             // Only warn if not in creation phase
                             if (!app.state.secretRooms.includes(roomId)) {
                                 // Deleted logic handled by snapshot usually, or user action
                             }
                            return;
                        }
                        const data = doc.data();
                        titleEl.innerText = data.title;
                        
                        if (data.isOfficial) {
                            badgeEl.classList.remove('hidden');
                            badgeEl.innerText = "å…¬å¼/Test";
                        } else {
                            badgeEl.classList.add('hidden');
                        }
                        
                        if (data.isPrivate) {
                            privateBadgeEl.classList.remove('hidden');
                        } else {
                            privateBadgeEl.classList.add('hidden');
                        }
                        
                    }, (error) => {
                        console.error("Thread Info Error", error);
                        if (error.code === 'permission-denied') {
                             alert("ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                             app.router.navigate('');
                        }
                    });

                    const msgsRef = app.fb.collection(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId, 'messages');
                    
                    app.state.unsubscribeRoom = app.fb.onSnapshot(msgsRef, (snapshot) => {
                        const messages = [];
                        snapshot.forEach(doc => messages.push(doc.data()));
                        messages.sort((a, b) => a.number - b.number);

                        msgContainer.innerHTML = '';
                        messages.forEach(msg => {
                            const div = app.logic.renderMessage(msg);
                            msgContainer.appendChild(div);
                        });
                        app.ui.scrollToBottom();
                    });
                },

                renderMessage(msg) {
                    const div = document.createElement('div');
                    div.id = `msg-${msg.number}`;
                    div.className = "flex gap-4 animate-fade-in group";
                    
                    const initial = (msg.name || "å").charAt(0);
                    let safeContent = app.logic.escapeHtml(msg.content);

                    // --- NEW: Advanced Formatting with Placeholders ---
                    const placeholders = [];
                    const addPlaceholder = (text) => {
                        placeholders.push(text);
                        return `%%%PH_${placeholders.length - 1}%%%`;
                    };

                    // 1. Escape \[...] (Highest priority)
                    safeContent = safeContent.replace(/\\\[(.*?)]/g, (match, p1) => addPlaceholder(p1));

                    // 2. Inline Code `...`
                    safeContent = safeContent.replace(/`(.*?)`/g, (match, p1) => addPlaceholder(`<code class="inline-code">${p1}</code>`));

                    // 3. Normal Formatting
                    // Spoiler ||...||
                    safeContent = safeContent.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler" onclick="this.classList.toggle(\'revealed\')">$1</span>');
                    
                    safeContent = safeContent.replace(/>>(\d+)/g, '<span class="msg-anchor" onclick="app.ui.highlightMessage($1)">>>$1</span>');
                    safeContent = safeContent.replace(/\*\*(.*?)\*\*/g, '<span class="msg-bold">$1</span>');
                    safeContent = safeContent.replace(/\*(.*?)\*/g, '<span class="msg-italic">$1</span>');
                    safeContent = safeContent.replace(/__(.*?)__/g, '<span class="msg-underline">$1</span>');
                    safeContent = safeContent.replace(/#color:\[([a-zA-Z0-9#]+)\]\((.*?)\)/g, '<span style="color:$1">$2</span>');
                    safeContent = safeContent.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                    safeContent = safeContent.replace(/\n/g, '<br>');

                    // 4. Restore Placeholders
                    safeContent = safeContent.replace(/%%%PH_(\d+)%%%/g, (match, id) => placeholders[id]);
                    // --------------------------------------------------

                    const timeStr = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : '--:--';

                    div.innerHTML = `
                        <div class="shrink-0 flex flex-col items-center gap-1">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 text-white flex items-center justify-center font-bold shadow-md text-lg">
                                ${initial}
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-base text-gray-800 dark:text-gray-100">${app.logic.escapeHtml(msg.name || 'åç„¡ã—ã•ã‚“')}</span>
                                <span class="msg-number">#${msg.number}</span>
                                <span class="text-xs text-gray-400 ml-auto">${timeStr}</span>
                            </div>
                            <div class="card p-3 rounded-2xl rounded-tl-none shadow-sm text-sm leading-relaxed msg-content break-words inline-block max-w-full border border-gray-100 dark:border-gray-700">
                                ${safeContent}
                            </div>
                            <div class="flex gap-4 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button onclick="app.ui.insertTag('>>${msg.number} ', '')" class="text-xs text-gray-400 hover:text-blue-500 transition cursor-pointer"><i class="fa-solid fa-reply mr-1"></i>è¿”ä¿¡</button>
                                <button onclick="app.logic.reportMessage('${msg.id}')" class="text-xs text-gray-400 hover:text-red-500 transition cursor-pointer"><i class="fa-solid fa-triangle-exclamation mr-1"></i>é€šå ±</button>
                            </div>
                        </div>
                    `;
                    return div;
                },

                escapeHtml(unsafe) {
                    return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                },

                async sendMessage(e) {
                    e.preventDefault();
                    if (!app.state.user || !app.state.currentRoomId) return;

                    const nameInput = document.getElementById('input-name');
                    const contentInput = document.getElementById('input-content');
                    const content = contentInput.value.trim();
                    const name = nameInput.value.trim();

                    if (!content) return;

                    contentInput.value = '';
                    contentInput.style.height = 'auto'; // Reset height
                    
                    const roomId = app.state.currentRoomId;
                    const threadRef = app.fb.doc(app.fb.db, 'artifacts', app.fb.appId, 'public', 'data', 'threads', roomId);
                    const msgsColl = app.fb.collection(threadRef, 'messages');

                    try {
                        await app.fb.runTransaction(app.fb.db, async (transaction) => {
                            const tDoc = await transaction.get(threadRef);
                            if (!tDoc.exists()) throw "Thread does not exist";

                            const newCount = (tDoc.data().messageCount || 0) + 1;
                            const newMsgRef = app.fb.doc(msgsColl);
                            
                            transaction.set(newMsgRef, {
                                id: newMsgRef.id,
                                number: newCount,
                                name: name,
                                content: content,
                                timestamp: app.fb.serverTimestamp(),
                                reports: 0
                            });

                            transaction.update(threadRef, {
                                messageCount: newCount,
                                lastUpdated: app.fb.serverTimestamp()
                            });
                        });
                        // No GSAP here for reliability
                        const btn = document.querySelector("#message-form button[type=submit]");
                        btn.classList.add("scale-90");
                        setTimeout(() => btn.classList.remove("scale-90"), 150);
                    } catch (e) {
                        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    }
                }
            }
        };

        // Event Bindings
        document.getElementById('message-form').addEventListener('submit', app.logic.sendMessage);
        
        // Textarea Behaviors (Enter to Send, Ctrl+Enter to Newline)
        const textarea = document.getElementById('input-content');
        textarea.addEventListener('keydown', function(e) {
            if (e.isComposing) return; // Ignore IME conversion keys

            if (e.key === 'Enter') {
                if (e.ctrlKey) {
                    // Ctrl+Enter: Insert Newline
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + "\n" + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 1;
                    
                    // Auto-resize trigger
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                } else if (!e.shiftKey) {
                    // Enter (no modifiers): Send
                    e.preventDefault();
                    app.logic.sendMessage(e);
                }
            }
        });

        // Auto-resize on input
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        window.onload = app.init;
    </script>
</body>
</html>
